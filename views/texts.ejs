<%- include('partials/header') %>

<div class="container mt-4">

    <!-- Top action bar with breadcrumbs and buttons -->
    <div class="d-flex justify-content-between align-items-center mb-4 pb-3 border-bottom">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb mb-0 bg-body rounded-pill px-3 py-1">
                <li class="breadcrumb-item"><a href="/texts"><i class="fas fa-home"></i> Root</a></li>
                <%# TODO: Add breadcrumb items from controller %>
                <% if (currentCategoryId) { %>
                    <!-- Placeholder for current folder name - requires fetching details -->
                    <li class="breadcrumb-item active" aria-current="page">Current Folder</li> <!-- Needs actual folder name -->
                <% } %>
            </ol>
        </nav>
        <div class="d-flex gap-2">
            <button type="button" class="btn btn-sm btn-success" data-bs-toggle="modal" data-bs-target="#createFolderModal">
                <i class="fas fa-folder-plus"></i> Create Folder
            </button>
            <a href="/add_text?parent_category_id=<%= currentCategoryId || 'root' %>" class="btn btn-sm btn-primary"><i class="fas fa-plus"></i> Add New Text</a> <!-- Pass current category to add text -->
        </div>
    </div>

    <% if (message) { %>
        <div class="alert alert-info alert-dismissible fade show" role="alert">
            <%= message %>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    <% } %>

        <!-- Create Folder Button (triggers modal) is now in the header section -->
    <!-- Folders List -->
    <!-- Folders Section - Wrapped in a Card -->
    <% if (categories && categories.length > 0) { %>
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-body-secondary">
                 <h4 class="mb-0"><i class="fas fa-folder-open me-2"></i>Folders</h4>
            </div>
            <div class="list-group list-group-flush">
                <% categories.forEach(category => { %>
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <a href="/texts?category_id=<%= category.id %>" class="text-decoration-none flex-grow-1 me-3">
                            <i class="fas fa-folder me-2 text-warning"></i><%= category.name %>
                        </a>
                        <div class="folder-actions d-flex gap-1">
                            <!-- Rename Form (Inline for simplicity, could be modal) -->
                            <form action="/categories/<%= category.id %>/rename" method="POST" class="d-inline-block" onsubmit="return handleRename(this);">
                                <input type="hidden" name="new_name" value="<%= category.name %>"> <!-- Pre-fill for prompt -->
                                <button type="submit" class="btn btn-sm btn-outline-secondary" title="Rename"><i class="fas fa-edit"></i></button>
                            </form>
                            <!-- Delete Form -->
                            <form action="/categories/<%= category.id %>/delete" method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure you want to delete this folder? Only empty folders can be deleted.');">
                                <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete"><i class="fas fa-trash"></i></button>
                            </form>
                        </div>
                    </div>
                <% }); %>
            </div>
        </div>
    <% } %>

    <!-- Texts List -->
    <!-- Texts Section - Wrapped in a Card -->
    <div class="card shadow-sm">
        <div class="card-header bg-body-secondary">
            <h4 class="mb-0"><i class="fas fa-file-alt me-2"></i>Texts</h4>
        </div>
        <% if (texts && texts.length > 0) { %>
            <div id="text-list" class="list-group list-group-flush">
                <% texts.forEach(text => { %>
                    <%
                        let percentage = 0;
                        if (text.content_length && text.content_length > 0) {
                            percentage = Math.round((text.progress_index / text.content_length) * 100);
                        } else if (text.progress_index === 0 && text.content_length === 0) {
                            percentage = 100; // Consider 0-length text as 100% complete
                        }
                        percentage = Math.min(percentage, 100); // Cap at 100%
                    %>
                    <div class="list-group-item d-flex justify-content-between align-items-center" data-id="<%= text.id %>">
                        <span class="flex-grow-1 me-3">
                             <i class="fas fa-file-alt me-2 text-secondary"></i>
                            <%= text.title %>
                            <small class="text-body-secondary ms-2">(<%= percentage %>%)</small>
                        </span>
                        <div class="actions d-flex align-items-center gap-1">
                            <!-- Other Action Buttons -->
                            <a href="/practice/<%= text.id %>" class="btn btn-sm btn-outline-info practice-btn" title="Practice"><i class="fas fa-keyboard"></i></a>
                            <a href="/edit_text/<%= text.id %>" class="btn btn-sm btn-outline-warning edit-btn" title="Edit"><i class="fas fa-edit"></i></a>
                            <form action="/delete_text/<%= text.id %>" method="POST" class="d-inline-block" onsubmit="return confirm('Are you sure you want to delete this text?');">
                                <button type="submit" class="btn btn-sm btn-outline-danger delete-btn" title="Delete"><i class="fas fa-trash"></i></button>
                            </form>
                        </div>
                    </div>
                <% }); %>
            </div>
        <% } else { %>
            <div class="card-body text-center text-body-secondary">
                <p class="mb-0">
                    <% if (currentCategoryId) { %>
                        No texts in this folder.
                    <% } else if (categories && categories.length > 0) { %>
                        No texts in the root folder.
                    <% } else { %>
                         This folder is empty. Add texts or create subfolders using the buttons above.
                    <% } %>
                 </p>
            </div>
        <% } %>
    </div>

     <% if (!texts || texts.length === 0 && (!categories || categories.length === 0)) { %>
         <p class="text-center text-body-secondary mt-4">This folder is empty. <a href="/add_text">Add a text</a> or create a new folder above.</p>
     <% } %>


</div>


<!-- Create Folder Modal -->
<div class="modal fade" id="createFolderModal" tabindex="-1" aria-labelledby="createFolderModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form action="/categories" method="POST">
        <div class="modal-header">
          <h5 class="modal-title" id="createFolderModalLabel">Create New Folder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
            <input type="hidden" name="parent_category_id" value="<%= currentCategoryId %>">
            <div class="mb-3">
              <label for="folderNameInput" class="form-label">Folder Name</label>
              <input type="text" name="name" class="form-control" id="folderNameInput" placeholder="Enter folder name..." required>
            </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success"><i class="fas fa-folder-plus"></i> Create</button>
        </div>
      </form>
    </div>
  </div>
</div>

<%- include('partials/footer') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
    // Rename Handler (simple prompt version)
    function handleRename(form) {
        const currentName = form.querySelector('input[name="new_name"]').value;
        const newName = prompt("Enter new folder name:", currentName);
        if (newName && newName.trim() !== '' && newName !== currentName) {
            form.querySelector('input[name="new_name"]').value = newName.trim();
            return true; // Proceed with form submission
        }
        return false; // Cancel submission
    }

    // SortableJS for Texts
    const textList = document.getElementById('text-list');
    if (textList) {
        new Sortable(textList, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            chosenClass: 'sortable-chosen',
            dragClass: 'sortable-drag',
            onEnd: function (evt) {
                const items = evt.to.children;
                const order = Array.from(items).map(item => item.dataset.id);

                fetch('/update_text_order', { // TODO: This needs context of the current folder if ordering is per-folder
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ order: order }),
                })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) console.error('Failed to update text order:', data.message);
                    else console.log('Text order updated');
                 })
                .catch((error) => console.error('Error updating text order:', error));
            },
        });
    }

    // Removed old toggleMoveForm function
</script>