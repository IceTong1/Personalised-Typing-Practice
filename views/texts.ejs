<%- include('partials/header', { user: user }) %>

<div class="flex-between-center mb-4">
    <h2>Your Texts</h2>
    <a href="/add_text" class="btn btn-primary">Add New Text</a>
</div>

<% if (message) { %>
    <div class="alert alert-info" role="alert">
        <%= message %>
    </div>
<% } %>

<% if (texts && texts.length > 0) { %>
    <div id="text-list" class="list-group">
        <% texts.forEach(text => { %>
            <%
                let percentage = 0;
                // Calculate percentage, handle division by zero for empty texts
                if (text.content_length && text.content_length > 0) {
                    percentage = Math.round((text.progress_index / text.content_length) * 100);
                } else if (text.progress_index === 0 && text.content_length === 0) {
                    // If content is empty and progress is 0, consider it 100% complete
                    percentage = 100;
                }
                // Ensure percentage doesn't exceed 100
                percentage = Math.min(percentage, 100);
            %>
            <div class="list-group-item d-flex" data-id="<%= text.id %>">
                <span>
                    <%= text.title %>
                    <small class="text-muted ms-2">(<%= percentage %>%)</small>
                </span>
                <div class="actions">
                    <a href="/practice/<%= text.id %>" class="btn btn-sm btn-info practice-btn">Practice</a>
                    <a href="/edit_text/<%= text.id %>" class="btn btn-sm btn-warning edit-btn">Edit</a>
                    <form action="/delete_text/<%= text.id %>" method="POST" style="display: inline;">
                        <button type="submit" class="btn btn-sm btn-danger delete-btn" onclick="return confirm('Are you sure you want to delete this text?');">Delete</button>
                    </form>
                </div>
            </div>
        <% }); %>
    </div>
<% } else { %>
    <p class="text-center text-body-secondary mt-4">You haven't added any texts yet. <a href="/add_text">Add one now!</a></p>
<% } %>

<%- include('partials/footer') %>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
<script>
    const textList = document.getElementById('text-list');
    if (textList) {
        new Sortable(textList, {
            animation: 150, // ms, animation speed moving items when sorting, `0` â€” without animation
            ghostClass: 'sortable-ghost', // Class name for the drop placeholder
            chosenClass: 'sortable-chosen', // Class name for the chosen item
            dragClass: 'sortable-drag', // Class name for the dragging item
            onEnd: function (evt) {
                // Get the new order of text IDs
                const items = evt.to.children;
                const order = Array.from(items).map(item => item.dataset.id);

                // Send the new order to the server
                fetch('/update_text_order', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ order: order }),
                })
                .then(response => response.json())
                .then(data => console.log('Order updated:', data)) // Optional: handle response
                .catch((error) => console.error('Error updating order:', error));
            },
        });
    }
</script>